local EXPECTED_URL = "https://raw.githubusercontent.com/SunOpenGL/5dax1/refs/heads/main/2x4"
local EXPECTED_HASH = "put_your_sha384_here"

local function validateKeySystem()
    if not getgenv().SOMTANK_KEY then
        return warn("❌ Unauthorized! Must pass key system first.")
    end

    local info = rawget(getgenv(), "_SomtankMarker")
    if type(info) ~= "table"
        or info.url ~= "Somtank_Huntyzombie"
        or typeof(info.token) ~= "Instance"
        or info.sourceUrl ~= EXPECTED_URL then
        return warn("❌ Invalid loader info or unauthorized source!")
    end

    -- ✅ Hybrid Anti-Tamper Check
    local ok, hash = pcall(function()
        -- กรณี script จริงเป็น Instance
        return getscripthash(info.token) -- token คุณตั้งเป็น Instance.new("Folder")
    end)

    if not ok or not hash then
        -- กรณี loadstring (ไม่มี Instance)
        local source = game:HttpGet(EXPECTED_URL)
        hash = crypt.hash(source, "sha384")
    end

    if hash ~= EXPECTED_HASH then
        return warn("❌ Script hash mismatch, possible tampering")
    end

    if getthreadidentity() ~= 2 then
        return warn("❌ Wrong thread identity")
    end

    print("✅ Main script loaded successfully from:", EXPECTED_URL)

    -- เคลียร์ marker กัน reuse
    pcall(function()
        getgenv()._SomtankMarker = nil
        getgenv().SOMTANK_KEY = false
    end)
end

-- Call
validateKeySystem()
