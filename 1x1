getgenv().SilentAura = getgenv().SilentAura or {}

getgenv().SilentAura.Start = function()
    repeat task.wait() until game:IsLoaded()

    local Players = game:GetService('Players')
    local Player = Players.LocalPlayer
    local Character = Player.Character or Player.CharacterAdded:Wait()
    local Humanoid = Character:WaitForChild("Humanoid")
    local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

    Player.CharacterAdded:Connect(function(NewCharacter)
        Character = NewCharacter
        Humanoid = Character:WaitForChild("Humanoid")
        HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    end)

    local AttackAnimations = {
        'rbxassetid://131430497821198',
        -- ... (อื่น ๆ ตัดออกเพื่อย่อ)
    }

    local RNG = Random.new()
    getgenv().SilentAura._conn = game:GetService('RunService').Heartbeat:Connect(function()
        if not HumanoidRootPart then return end

        local Playing = false
        for _, v in Humanoid:GetPlayingAnimationTracks() do
            if table.find(AttackAnimations, v.Animation.AnimationId) and (v.TimePosition / v.Length < 0.75) then
                Playing = true
            end
        end
        if not Playing then return end

        local Target
        local NearestDist = 120

        local function loop(t)
            for _, v in t do
                if v == Character or not v:FindFirstChild("HumanoidRootPart") then continue end
                local dist = (v.HumanoidRootPart.Position - HumanoidRootPart.Position).Magnitude
                if dist < NearestDist then
                    NearestDist = dist
                    Target = v
                end
            end
        end

        loop(workspace.Players:GetDescendants())
        local npcs = workspace:FindFirstChild("Map", true)
        if npcs and npcs:FindFirstChild("NPCs") then
            loop(npcs.NPCs:GetChildren())
        end

        if not Target then return end

        local OldVelocity = HumanoidRootPart.Velocity
        local NeededVelocity =
            (Target.HumanoidRootPart.Position + Vector3.new(RNG:NextNumber(-1.5, 1.5), 0, RNG:NextNumber(-1.5, 1.5))
            + (Target.HumanoidRootPart.Velocity * (Player:GetNetworkPing() * 1.25))
            - HumanoidRootPart.Position)
            / (Player:GetNetworkPing() * 2)

        HumanoidRootPart.Velocity = NeededVelocity
        game:GetService("RunService").RenderStepped:Wait()
        HumanoidRootPart.Velocity = OldVelocity
    end)
end

getgenv().SilentAura.Stop = function()
    if getgenv().SilentAura._conn then
        getgenv().SilentAura._conn:Disconnect()
        getgenv().SilentAura._conn = nil
    end
end
